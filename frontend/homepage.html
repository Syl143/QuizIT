<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuizIt | Dashboard</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/homepage.css" />
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <div class="logo">QuizIt</div>
        <img
            src="https://img.icons8.com/?size=100&id=105515&format=png&color=FFFFFF"
            alt="Toggle Sidebar"
            class="toggle-icon"
            id="toggleSidebar"
        />
        </div>
        <ul class="menu">
            <li class="active"><a href="homepage.html"><i class="fa-solid fa-house"></i><span>Home</span></a></li>          
            <li>
                <a href="quizzes.html">
                <img src="https://img.icons8.com/?size=100&id=rx6rZTa05YPn&format=png&color=FFFFFF" 
                    alt="Quiz Icon" class="menu-icon" />
                <span>Quizzes</span>
                </a>
            </li>
            
            <li><a href="leaderboards.html"><i class="fa-solid fa-trophy"></i><span>Leaderboards</span></a></li>
            
            <li><a href="community.html"><i class="fa-solid fa-comments"></i><span>Community</span></a></li>
            
            <li><a href="profile.html"><i class="fa-solid fa-user"></i><span>Profile</span></a></li>
        </ul>
        <div class="logout" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>Logout</span>
        </div>
    </div>

<!-- Main Content -->
<div class="main">
  <header>
    <div class="tabs">
      <button type="button" class="tab active" data-tab="overview">Overview</button>
      <button type="button" class="tab" data-tab="my-courses">My Courses</button>
      <button type="button" class="tab" data-tab="all-courses">All Courses</button>
    </div>

    <div class="profile-card">
      <img src="https://img.icons8.com/color/96/000000/user-male-circle--v1.png" alt="Profile" />
      <div class="profile-info">
        <h3>User Name</h3>
        <p>BSIT Student</p>
      </div>
    </div>
  </header>

  <!-- ================= OVERVIEW TAB ================= -->
  <section id="overview" class="tab-content active">
    <div class="overview-grid">
      <!-- Course Progress Overview -->
      <div class="card stats-card">
        <h3>Course Progress Overview</h3>
        <canvas id="progressChart"></canvas>
      </div>

      <!-- XP Card -->
      <div class="card xp-card">
        <h3>Experience Points</h3>
        
        <div class="level-wrapper">
          <img src="" alt="Level Icon" class="level-icon">
          <span class="level-title">Level Title</span>
        </div>
        <p class="xp-value">0 XP</p>
        <div class="progress-bar">
          <div class="progress" style="width: 0%"></div>
        </div>
      </div>

      <!-- Suggested Courses -->
      <div class="card suggestion-card">
        <h3>Suggested Courses</h3>
        <div class="suggested-course">
          <img src="https://img.icons8.com/color/96/javascript.png" alt="">
          <div>
            <h4>Advanced JavaScript</h4>
            <p>Deepen your JS knowledge</p>
          </div>
        </div>
        <div class="suggested-course">
          <img src="https://img.icons8.com/color/96/data-configuration.png" alt="">
          <div>
            <h4>Data Structures</h4>
            <p>Boost your algorithmic thinking</p>
          </div>
        </div>
        <div class="suggested-course">
          <img src="https://img.icons8.com/?size=100&id=97384&format=png&color=000000" alt="">
          <div>
            <h4>Machine Learning Basics</h4>
            <p>Start exploring AI and automation</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Lesson History -->
    <div class="card history-card">
      <h3>Lesson History</h3>
      <div class="history-table-wrapper">
        <table class="lesson-history-table">
          <thead>
            <tr>
              <th>Lesson Title</th>
              <th>Course</th>
              <th>Date Completed</th>
              <th>XP Earned</th>
            </tr>
          </thead>
          <tbody id="lessonHistoryBody">
            <tr><td colspan="4">Loading history...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ================= MY COURSES TAB ================= -->
  <section id="my-courses" class="tab-content">
    <div class="section-header">
      <h2>My Courses</h2>
      <input
        type="text"
        id="searchMyCourses"
        name="searchMyCourses"
        class="search-bar"
        placeholder="Search My Courses..."
        autocomplete="off"
      >
    </div>
    <div class="courses-container"></div>
  </section>

  <!-- ================= COURSE DETAIL PANEL ================= -->
  <section id="course-detail-panel" class="inside-content hidden">
    <button type="button" class="back-btn" id="back-to-courses">‚Üê Back</button>
    <div class="course-detail-content">
      <h2 id="course-title"></h2>
      <div id="lessons-list"></div>
    </div>
  </section>

  <!-- ================= LESSON PANEL ================= -->
  <section id="lesson-panel" class="inside-content hidden">
    <button type="button" class="back-btn" id="back-to-course">‚Üê Back to Lessons</button>
    <div class="lesson-content">
      <h3 id="lesson-title"></h3>
      <div class="lesson-intro" id="lesson-intro"></div>
      <div class="lesson-slider" id="lesson-slider"></div>
      <div class="slider-controls">
        <button type="button" id="prev-btn" disabled>Prev</button>
        <button type="button" id="hint-btn">üí° Hint (3 left)</button>
        <button type="button" id="next-btn">Next</button>
      </div>
      <div id="hint-box" class="hint-box hidden"></div>
    </div>
  </section>

  <!-- ================= ALL COURSES TAB ================= -->
  <section id="all-courses" class="tab-content">
    <div class="section-header">
      <h2>All Courses</h2>
      <input
        type="text"
        id="searchAllCourses"
        name="searchAllCourses"
        class="search-bar"
        placeholder="Search All Courses..."
        autocomplete="off"
      >
    </div>
    <div class="courses-container"></div>
  </section>

  <div id="completion-popup" class="completion-popup">
    <div class="popup-content">
      <p id="completion-message">Lesson completed!</p>
      <p id="xp-earned-message"></p>
      <button type="button" id="popup-back-btn">Back to Course Details</button>
    </div>
  </div>

  <footer>¬© 2025 QuizIt ‚Äî All Rights Reserved</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  document.addEventListener("submit", e => e.preventDefault());
  document.addEventListener("keydown", e => {
    const active = document.activeElement;
    if (e.key === "Enter" && active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) {
      if (active.tagName === "INPUT") e.preventDefault();
    }
  });

  // ----- CONFIG -----
  const API_BASE = "http://localhost:3000";
  const DB_ENDPOINT = `${API_BASE}/db`;
  const LOCAL_USERS_KEY = "quizit_local_users";
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  async function safeFetchJSON(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Server not available");
      return await res.json();
    } catch (err) {
      console.warn("‚ö†Ô∏è Using local fallback:", err);
      return null;
    }
  }

  // ----- TAB SWITCHING -----
  const tabs = qsa(".tab");
  const contents = qsa(".tab-content");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      contents.forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      const target = document.getElementById(tab.dataset.tab);
      if (target) target.classList.add("active");
    });
  });

  // ----- SESSION CHECK -----
  const sessionUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
  if (!sessionUser) {
    alert("Please log in first.");
    window.location.href = "index.html";
    return;
  }

  // ----- LOAD DATABASE -----
  const db = await safeFetchJSON(DB_ENDPOINT);
  if (!db) {
    alert("Database could not be loaded. Ensure json-server is running with db.json");
    return;
  }

  const users = db.users || [];
  const lessonsData = (db.lessons && db.lessons[0]) || {};
  const milestones = (db.milestones && db.milestones[0]) || { levels: [], badges: [] };

  // ----- FIND USER -----
  let user = users.find(u => u.email === sessionUser.email);
  if (!user) {
    alert("User not found.");
    sessionStorage.clear();
    window.location.href = "index.html";
    return;
  }

  user.myCourses ??= [];
  user.lessonHistory ??= [];
  user.totalXP ??= 0;

  // ----- ELEMENTS -----
  const xpValueEl = qs(".xp-value");
  const profileNameEl = qs(".profile-info h3");
  const xpProgress = qs(".xp-card .progress");
  const myCoursesContainer = qs("#my-courses .courses-container");
  const allCoursesContainer = qs("#all-courses .courses-container");
  const lessonHistoryBody = qs("#lessonHistoryBody");
  const progressChartCanvas = qs("#progressChart");

  // ----- SAVE USER -----
  async function saveUser(updatedUser) {
    const idx = users.findIndex(u => u.email === updatedUser.email);
    if (idx !== -1) users[idx] = updatedUser;

    sessionStorage.setItem("loggedInUser", JSON.stringify(updatedUser));

    try {
      const res = await fetch(`${API_BASE}/users/${updatedUser.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          totalXP: updatedUser.totalXP,
          myCourses: updatedUser.myCourses,
          lessonHistory: updatedUser.lessonHistory
        })
      });
      if (!res.ok) throw new Error("PATCH failed");
      localStorage.setItem(LOCAL_USERS_KEY, JSON.stringify(users));
      return true;
    } catch (err) {
      console.warn("‚ö†Ô∏è Saving locally (server failed):", err);
      localStorage.setItem(LOCAL_USERS_KEY, JSON.stringify(users));
      return false;
    }
  }

  // ----- XP SYSTEM -----
  function updateXP() {
    const total = user.lessonHistory.reduce((sum, l) => sum + (l.xpEarned || 0), 0);
    user.totalXP = total;
    const level =
      milestones.levels.find(l => total >= l.minXP && total <= l.maxXP) ||
      milestones.levels[milestones.levels.length - 1];
    const percent = Math.min(((total - level.minXP) / (level.maxXP - level.minXP)) * 100, 100);
    xpValueEl.textContent = `${total} XP`;
    xpProgress.style.width = `${percent}%`;
    xpProgress.style.background = level.color;
    const icon = document.querySelector(".xp-card .level-icon");
    const title = document.querySelector(".xp-card .level-title");
    if (icon) icon.src = level.icon;
    if (title) title.textContent = level.title;
  }

  // ----- RENDERERS -----
  function renderProfile() {
    profileNameEl.textContent = user.fullname;
    updateXP();
  }

  function enrolledKeys() {
    return user.myCourses.map(c => c.courseKey);
  }

  function renderMyCourses() {
    myCoursesContainer.innerHTML = "";
    const keys = enrolledKeys();
    if (!keys.length) {
      myCoursesContainer.innerHTML = `<p class="placeholder">You have no enrolled courses yet.</p>`;
      return;
    }
    keys.forEach(k => {
      const c = lessonsData[k];
      if (!c) return;
      const completed = user.lessonHistory.filter(h => h.course === c.title).length;
      const total = c.lessons.length;
      const percent = Math.round((completed / total) * 100);
      const card = document.createElement("div");
      card.className = "course-card";
      card.innerHTML = `
        <img src="${c.icon}" alt="${c.title}">
        <div class="course-info">
          <h3>${c.title}</h3>
          <p>${c.description}</p>
          <p>Progress: <strong>${percent}%</strong></p>
          <div class="progress-bar"><div class="progress" style="width:${percent}%"></div></div>
        </div>
      `;
      card.onclick = () => showCourseDetails(k);
      myCoursesContainer.appendChild(card);
    });
  }

  async function renderAllCourses() {
    allCoursesContainer.innerHTML = "";
    const enrolled = new Set(enrolledKeys());
    for (const key in lessonsData) {
      if (enrolled.has(key)) continue;
      const c = lessonsData[key];
      const card = document.createElement("div");
      card.className = "course-card";
      card.innerHTML = `
        <img src="${c.icon}">
        <div class="course-info">
          <h3>${c.title}</h3>
          <p>${c.description}</p>
          <button class="enroll-btn">Enroll</button>
        </div>
      `;
      card.querySelector(".enroll-btn").onclick = async e => {
        e.stopPropagation();
        await enrollCourse(user, key, c.title);
        renderAllCourses();
        renderMyCourses();
      };
      allCoursesContainer.appendChild(card);
    }
  }

  async function enrollCourse(user, courseKey, title) {
    if (user.myCourses.some(c => c.courseKey === courseKey)) {
      showToast(`Already enrolled in ${title}`);
      return;
    }
    user.myCourses.push({ id: Date.now(), courseKey });
    await saveUser(user);
    showToast(`‚úÖ Enrolled in "${title}"`);
  }

  function renderLessonHistory() {
    lessonHistoryBody.innerHTML = "";
    if (!user.lessonHistory.length) {
      lessonHistoryBody.innerHTML = `<tr><td colspan="4">No lessons completed yet.</td></tr>`;
      return;
    }
    user.lessonHistory.slice().reverse().forEach(h => {
      lessonHistoryBody.innerHTML += `
        <tr>
          <td>${h.lessonTitle}</td>
          <td>${h.course}</td>
          <td>${h.dateCompleted}</td>
          <td>${h.xpEarned} XP</td>
        </tr>
      `;
    });
  }

  function renderChart() {
    const ctx = progressChartCanvas.getContext("2d");
    const labels = [];
    const data = [];
    user.myCourses.forEach(c => {
      const course = lessonsData[c.courseKey];
      if (!course) return;
      labels.push(course.title);
      const totalXP = user.lessonHistory
        .filter(h => h.course === course.title)
        .reduce((s, h) => s + (h.xpEarned || 0), 0);
      data.push(totalXP);
    });
    if (window.xpChart) window.xpChart.destroy();
    window.xpChart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ data, backgroundColor: "#00b4d8", borderRadius: 8, barThickness: 20 }] },
      options: { indexAxis: "y", plugins: { legend: { display: false } } }
    });
  }

  // ----- LESSON PANEL -----
  const courseDetailPanel = qs("#course-detail-panel");
  const lessonPanel = qs("#lesson-panel");
  const coursesSection = qs("#my-courses");
  const courseTitleEl = qs("#course-title");
  const lessonsListEl = qs("#lessons-list");
  const lessonTitleEl = qs("#lesson-title");
  const lessonIntroEl = qs("#lesson-intro");
  const backToCoursesBtn = qs("#back-to-courses");
  const backToLessonListBtn = qs("#back-to-course");
  const hintBtn = qs("#hint-btn");
  const hintBoxEl = qs("#hint-box");
  const prevBtn = qs("#prev-btn");
  const nextBtn = qs("#next-btn");

  window.showCourseDetails = function(courseKey) {
    const course = lessonsData[courseKey];
    if (!course) return;
    coursesSection.classList.add("hidden");
    courseDetailPanel.classList.remove("hidden");
    lessonPanel.classList.add("hidden");
    courseTitleEl.textContent = course.title;
    lessonsListEl.innerHTML = "";
    course.lessons.forEach(lesson => {
      const done = user.lessonHistory.some(h => h.lessonTitle === lesson.title && h.course === course.title);
      const div = document.createElement("div");
      div.className = "lesson-card";
      if (done) div.classList.add("completed");
      div.innerHTML = `
        <span>${lesson.title}</span>
        <button class="learn-btn">${done ? "View" : "Start"}</button>
        ${done ? '<span class="completed-badge">‚úÖ</span>' : ""}
      `;
      div.querySelector(".learn-btn").onclick = () => showLesson(courseKey, lesson.title);
      lessonsListEl.appendChild(div);
    });
  };

  function showLesson(courseKey, lessonTitle) {
    const course = lessonsData[courseKey];
    const lesson = course.lessons.find(l => l.title === lessonTitle);
    if (!lesson) return;
    courseDetailPanel.classList.add("hidden");
    lessonPanel.classList.remove("hidden");
    lessonTitleEl.textContent = lesson.title;
    lessonIntroEl.textContent = lesson.content;
    const slider = qs("#lesson-slider");
    slider.innerHTML = "";

    function escapeHtml(text) {
      const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    lesson.questions.forEach((q, i) => {
      const slide = document.createElement("div");
      slide.className = "slide";
      slide.style.display = i === 0 ? "block" : "none";
      if (q.type === "multiple-choice") {
        const opts = q.options.map(o => `
          <label><input type="radio" name="q${i}" value="${escapeHtml(o)}"> ${escapeHtml(o)}</label>
        `).join("");
        slide.innerHTML = `
          <p>${i + 1}. ${q.text}</p>
          <div>${opts}</div>
          <button class="submit-btn">Submit</button>
          <div class="feedback"></div>
        `;
      } else {
        slide.innerHTML = `
          <p>${i + 1}. ${q.text}</p>
          <input class="short-answer-input" placeholder="Your answer...">
          <button class="submit-btn">Submit</button>
          <div class="feedback"></div>
        `;
      }
      slider.appendChild(slide);
    });

    let current = 0;
    let hints = 3;

    function showSlide(n) {
      const slides = slider.querySelectorAll(".slide");
      slides.forEach((s, i) => s.style.display = i === n ? "block" : "none");
      current = n;
      prevBtn.disabled = current === 0;
      nextBtn.disabled = true;
      nextBtn.textContent = current === slides.length - 1 ? "Finish Lesson" : "Next";
      hintBoxEl.classList.add("hidden");
    }
    showSlide(0);

    hintBtn.onclick = () => {
      if (hints <= 0) return;
      const hint = lesson.questions[current]?.hint || "No hint available.";
      hintBoxEl.textContent = hint;
      hintBoxEl.classList.remove("hidden");
      hints--;
      hintBtn.textContent = `üí° Hint (${hints} left)`;
    };

    slider.querySelectorAll(".slide").forEach((slide, idx) => {
      const btn = slide.querySelector(".submit-btn");
      const feedback = slide.querySelector(".feedback");
      let attempts = 2;
      btn.onclick = () => {
        const q = lesson.questions[idx];
        let correct = false;
        if (q.type === "multiple-choice") {
          const selected = slide.querySelector("input:checked");
          if (!selected) return alert("Select an option first.");
          correct = selected.value === q.answer;
        } else {
          const input = slide.querySelector(".short-answer-input");
          if (!input.value.trim()) return alert("Type an answer.");
          correct = input.value.trim().toLowerCase() === q.answer.toLowerCase();
        }
        attempts--;
        if (correct) {
          feedback.textContent = "‚úÖ Correct!";
          feedback.style.color = "#2a9d8f";
          btn.disabled = true;
          nextBtn.disabled = false;
        } else {
          feedback.textContent = attempts > 0
            ? `‚ùå Incorrect (${attempts} tries left)`
            : `Answer: ${q.answer}`;
          feedback.style.color = "#e63946";
          if (attempts <= 0) {
            btn.disabled = true;
            nextBtn.disabled = false;
          }
        }
      };
    });

    prevBtn.onclick = () => { if (current > 0) showSlide(current - 1); };
    nextBtn.onclick = () => {
      const total = lesson.questions.length;
      if (current < total - 1) showSlide(current + 1);
      else completeLesson(course, lesson);
    };
  }

  async function completeLesson(course, lesson) {
    const done = user.lessonHistory.some(h => h.lessonTitle === lesson.title && h.course === course.title);
    if (done) return;
    const xpEarned = lesson.questions.reduce((s, q) => s + (q.xp || 0), 0) || lesson.lessonXP || 50;
    user.lessonHistory.push({
      course: course.title,
      lessonTitle: lesson.title,
      xpEarned,
      dateCompleted: new Date().toLocaleDateString()
    });
    await saveUser(user);
    updateXP();
    renderMyCourses();
    renderLessonHistory();
    renderChart();
    showToast(`üéâ ${lesson.title} completed! +${xpEarned} XP`);
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    setTimeout(() => backToLessonListBtn.click(), 3000);
  }

  // ----- NAVIGATION -----
  backToCoursesBtn.onclick = () => {
    coursesSection.classList.remove("hidden");
    courseDetailPanel.classList.add("hidden");
  };
  backToLessonListBtn.onclick = () => {
    lessonPanel.classList.add("hidden");
    courseDetailPanel.classList.remove("hidden");
  };

  // ----- TOAST -----
  function showToast(msg) {
    const t = document.createElement("div");
    t.className = "toast-message";
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.classList.add("show"), 50);
    setTimeout(() => { t.classList.remove("show"); setTimeout(() => t.remove(), 300); }, 2500);
  }

  // ----- LOGOUT -----
  window.logout = () => {
    sessionStorage.clear();
    window.location.href = "index.html";
  };

  // Sidebar toggle
  const sidebar = qs(".sidebar");
  const toggleBtn = qs("#toggleSidebar");
  if (toggleBtn) toggleBtn.onclick = () => sidebar.classList.toggle("collapsed");

  // ----- INITIALIZE -----
  renderProfile();
  renderMyCourses();
  renderAllCourses();
  renderLessonHistory();
  renderChart();
});
</script>






</body>
</html>
