<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuizIt | Dashboard</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/homepage.css" />
    <link rel="stylesheet" href="css/quizzes.css" />
    <link rel="stylesheet" href="css/community.css" />
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <div class="logo">QuizIt</div>
        <img
            src="https://img.icons8.com/?size=100&id=105515&format=png&color=FFFFFF"
            alt="Toggle Sidebar"
            class="toggle-icon"
            id="toggleSidebar"
        />
        </div>
        <ul class="menu">
            <li><a href="homepage.html"><i class="fa-solid fa-house"></i><span>Home</span></a></li>
            
            <li>
                <a href="quizzes.html">
                <img src="https://img.icons8.com/?size=100&id=rx6rZTa05YPn&format=png&color=FFFFFF" 
                    alt="Quiz Icon" class="menu-icon" />
                <span>Quizzes</span>
                </a>
            </li>
            
            <li><a href="leaderboards.html"><i class="fa-solid fa-trophy"></i><span>Leaderboards</span></a></li>
            
            <li class="active"><a href="community.html"><i class="fa-solid fa-comments"></i><span>Community</span></a></li>
            
            <li><a href="profile.html"><i class="fa-solid fa-user"></i><span>Profile</span></a></li>
        </ul>
        <div class="logout" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>Logout</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
    <header>
        <div class="tabs">
            <button class="tab active" data-tab="discussions">Discussions</button>
            <button class="tab" data-tab="my-feed">My Feed</button>
        </div>
      <div class="profile-card">
        <img
          src="https://img.icons8.com/color/96/000000/user-male-circle--v1.png"
          alt="Profile"
        />
        <div class="profile-info">
          <h3>User Name</h3>
          <p>BSIT Student</p>
        </div>
      </div>
    </header>

    <section id="discussions-section" class="section">
      <div class="discussion-main">
        <div class="new-post"> ... </div>
        <!-- JS dynamically injects all posts here -->
      </div>

      <aside id="trending-topics">
        <h3>🔥 Trending Topics</h3>
        <ul class="trending-list"></ul>
      </aside>
    </section>



<!-- ===== Feed Section ===== -->
<section id="feed-section" class="section">
  <!-- New Feed Post Box -->
  <div class="feed-new-post">
    <div class="feed-post-header">
      <img
        src="https://img.icons8.com/color/48/000000/user-male-circle--v1.png"
        alt="User"
        class="feed-user-icon"
      />
      <input
        type="text"
        id="feed-new-text"
        placeholder="What's on your mind?"
      />
    </div>

    <div class="feed-post-attachments">
      <label>
        <i class="fa-solid fa-image"></i>
        <input type="file" id="feed-image-upload" accept="image/*" hidden />
      </label>
      <label>
        <i class="fa-solid fa-video"></i>
        <input type="file" id="feed-video-upload" accept="video/*" hidden />
      </label>
      <label>
        <i class="fa-solid fa-link"></i>
        <input type="url" id="feed-link-input" placeholder="Paste link..." />
      </label>
    </div>

    <button id="feed-post-btn">
      <i class="fa-solid fa-paper-plane"></i> Post
    </button>
  </div>

  <!-- Feed Posts Container -->
  <div id="feed-posts-container">
    <!-- Posts are dynamically rendered here by feed.js -->
  </div>
</section>
    

    <footer>© 2025 QuizIt — All Rights Reserved</footer>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  // ----- CONFIG -----
  const isLocal = window.location.hostname === "localhost";
  const API_BASE = isLocal
    ? "http://localhost:10000"
    : "https://quizit-backend-0xxm.onrender.com";

  const USERS_ENDPOINT = `${API_BASE}/users`;
  const DISCUSSIONS_ENDPOINT = `${API_BASE}/discussions`;
  const TOPICS_ENDPOINT = `${API_BASE}/topics`;
  const LOCAL_USERS_KEY = "quizit_local_users";

  const qs = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));

  // ----- TAB SWITCHING -----
  const tabs = qsa(".tab");
  const sections = {
    discussions: qs("#discussions-section"),
    "my-feed": qs("#feed-section"),
  };

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      tabs.forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");
      Object.values(sections).forEach((sec) => sec.classList.remove("active"));
      sections[tab.dataset.tab].classList.add("active");
    });
  });
  sections["discussions"].classList.add("active");

  // ----- SESSION CHECK -----
  const sessionUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
  if (!sessionUser) {
    alert("Please log in first.");
    window.location.href = "index.html";
    return;
  }

  // ----- LOAD USERS -----
  let users = [];
  try {
    const res = await fetch(USERS_ENDPOINT);
    if (!res.ok) throw new Error("json-server not available");
    users = await res.json();
  } catch {
    const stored = localStorage.getItem(LOCAL_USERS_KEY);
    users = stored ? JSON.parse(stored) : [];
  }

  const user = users.find((u) => u.email === sessionUser.email);
  if (!user) {
    alert("User not found.");
    sessionStorage.clear();
    window.location.href = "index.html";
    return;
  }

  // ----- LOAD COMMUNITY -----
  async function loadCommunity() {
    try {
      const [discRes, topicRes] = await Promise.all([
        fetch(DISCUSSIONS_ENDPOINT),
        fetch(TOPICS_ENDPOINT),
      ]);

      const discussions = await discRes.json();
      const topics = await topicRes.json();

      renderDiscussions(discussions);
      renderTopics(topics);
    } catch (err) {
      console.error("Error loading community:", err);
    }
  }

  // ----- RENDER DISCUSSIONS -----
  function renderDiscussions(discussions) {
    const main = qs(".discussion-main");
    main.innerHTML = `
      <div class="new-post">
        <div class="new-post-header">
          <img src="https://img.icons8.com/color/48/000000/user-male-circle--v1.png" class="user-icon" />
          <input type="text" id="new-post-title" placeholder="Post title..." />
        </div>
        <input type="text" id="new-post-text" placeholder="Share your thoughts..." />
        <button id="post-btn"><i class="fa-solid fa-paper-plane"></i> Post</button>
      </div>`;

    // ----- Add New Discussion -----
    const postBtn = main.querySelector("#post-btn");
    postBtn.addEventListener("click", async () => {
      const title = qs("#new-post-title").value.trim();
      const content = qs("#new-post-text").value.trim();
      if (!title || !content) {
        alert("Please enter both title and content.");
        return;
      }

      const newPost = {
        title,
        content,
        author: user.id,
        votes: 0,
        timestamp: new Date().toLocaleString("en-US", { hour12: true }),
        comments: [],
      };

      try {
        const res = await fetch(DISCUSSIONS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newPost),
        });
        if (!res.ok) throw new Error("Failed to create discussion");
        const created = await res.json();
        discussions.push(created);
        renderDiscussions(discussions);
      } catch (err) {
        console.error("Error posting discussion:", err);
        alert("❌ Failed to add post. Please try again.");
      }
    });

    // ----- Render Existing Discussions -----
    discussions.forEach((d) => {
      const card = document.createElement("div");
      card.classList.add("discussion-card");
      card.dataset.id = d.id;

      card.innerHTML = `
        <div class="vote-panel">
          <button class="vote-btn upvote">⬆</button>
          <span class="vote-count">${d.votes}</span>
          <button class="vote-btn downvote">⬇</button>
        </div>
        <div class="post-content">
          <h3>${d.title}</h3>
          <p>
            <img src="${getUserAvatar(d.author)}" class="user-icon-small" />
            <strong>${getUserName(d.author)}:</strong> ${d.content}
          </p>
          <div class="post-actions">
            <span class="comments-toggle">💬 ${d.comments.length} Comment</span>
            <span>🕒 ${d.timestamp}</span>
          </div>
          <div class="comments-section hidden">
            <div class="comments-list">
              ${d.comments
                .map(
                  (c) => `
                <div class="comment">
                  <img src="${getUserAvatar(c.author)}" class="user-icon-small" />
                  <strong>${getUserName(c.author)}:</strong> ${c.content}
                </div>`
                )
                .join("")}
            </div>
            <div class="reply-input-container">
              <input type="text" class="reply-input" placeholder="Write a reply..." />
              <button class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
          </div>
        </div>`;

      main.appendChild(card);
    });

    // Toggle comment sections
    qsa(".comments-toggle").forEach((btn) =>
      btn.addEventListener("click", (e) => {
        const section = e.target
          .closest(".post-content")
          .querySelector(".comments-section");
        section.classList.toggle("hidden");
      })
    );

    // Voting
    qsa(".upvote").forEach((btn) =>
      btn.addEventListener("click", () => updateVote(btn, 1))
    );
    qsa(".downvote").forEach((btn) =>
      btn.addEventListener("click", () => updateVote(btn, -1))
    );

    // ----- Add Reply (POST /discussions/:id/comments) -----
    qsa(".send-btn").forEach((btn) =>
      btn.addEventListener("click", async (e) => {
        const card = e.target.closest(".discussion-card");
        const input = card.querySelector(".reply-input");
        const commentText = input.value.trim();
        if (!commentText) return alert("Please enter a comment.");

        const discussionId = card.dataset.id;

        const newComment = {
          id: Date.now(),
          author: user.id,
          content: commentText,
        };

        try {
          // Fetch the discussion to update comments
          const res = await fetch(`${DISCUSSIONS_ENDPOINT}/${discussionId}`);
          const discussion = await res.json();

          // Append new comment
          discussion.comments.push(newComment);

          // Update discussion on server
          const updateRes = await fetch(`${DISCUSSIONS_ENDPOINT}/${discussionId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(discussion),
          });

          if (!updateRes.ok) throw new Error("Failed to post comment");

          input.value = "";
          await loadCommunity(); // refresh discussions
        } catch (err) {
          console.error("Error adding comment:", err);
          alert("❌ Failed to add comment.");
        }
      })
    );
  }

  // ----- UPDATE VOTES -----
  function updateVote(btn, change) {
    const card = btn.closest(".discussion-card");
    const countEl = card.querySelector(".vote-count");
    let votes = parseInt(countEl.textContent) + change;
    if (votes < 0) votes = 0;
    countEl.textContent = votes;
  }

  // ----- RENDER TOPICS -----
  function renderTopics(topics) {
    const list = qs(".trending-list");
    list.innerHTML = topics
      .map(
        (t) => `
        <li>
          <span class="topic-tag">${t.tag}</span>
          <span class="topic-title">${t.title}</span>
          <span class="topic-count">${t.count}</span>
        </li>`
      )
      .join("");
  }

  // ----- USER FEED -----
  async function loadUserFeed() {
    try {
      const res = await fetch(DISCUSSIONS_ENDPOINT);
      const discussions = await res.json();
      const myPosts = discussions.filter((p) => p.author === user.id);
      renderUserFeed(myPosts);
    } catch (err) {
      console.error("Error loading feed:", err);
    }
  }

  function renderUserFeed(posts) {
    const container = qs("#feed-posts-container");
    container.innerHTML = "";
    if (posts.length === 0) {
      container.innerHTML = `<p class="no-posts">You haven’t posted anything yet.</p>`;
      return;
    }

    posts.forEach((p) => {
      const postCard = document.createElement("div");
      postCard.classList.add("feed-post-card");
      postCard.innerHTML = `
        <div class="feed-post-header">
          <img src="${getUserAvatar(p.author)}" alt="User" class="feed-user-icon">
          <div>
            <h4 class="feed-user-name">${getUserName(p.author)}</h4>
            <p class="feed-timestamp">${p.timestamp}</p>
          </div>
        </div>
        <p class="feed-post-content">${p.title}: ${p.content}</p>
        <div class="feed-post-actions">
          <div class="feed-left-actions">
            <button class="feed-like-btn">
              <i class="fa-solid fa-thumbs-up"></i> Like <span class="feed-like-count">${p.votes}</span>
            </button>
            <button class="feed-comment-btn">
              <i class="fa-solid fa-comment"></i> Comment (${p.comments.length})
            </button>
          </div>
          <button class="feed-share-btn"><i class="fa-solid fa-share"></i> Share</button>
        </div>`;
      container.appendChild(postCard);
    });
  }

  // ----- HELPERS -----
  function getUserName(id) {
    if (id === user.id) return "You";
    const u = users.find((x) => x.id === id);
    return u ? u.fullname : "Guest";
  }

  function getUserAvatar(id) {
    if (id === user.id)
      return "https://img.icons8.com/color/48/000000/user-male-circle--v1.png";
    return "https://img.icons8.com/color/48/000000/user.png";
  }

  // ----- INIT -----
  await loadCommunity();
  await loadUserFeed();

  // Sidebar toggle
  const sidebar = qs(".sidebar");
  const toggleBtn = qs("#toggleSidebar");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
    });
  }

  // Logout
  window.logout = function () {
    sessionStorage.clear();
    window.location.href = "index.html";
  };
});
</script>





</body>
</html>
