<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuizIt | Dashboard</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/homepage.css" />
    <link rel="stylesheet" href="css/quizzes.css" />
    <link rel="stylesheet" href="css/community.css" />
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
        <div class="logo">QuizIt</div>
        <img
            src="https://img.icons8.com/?size=100&id=105515&format=png&color=FFFFFF"
            alt="Toggle Sidebar"
            class="toggle-icon"
            id="toggleSidebar"
        />
        </div>
        <ul class="menu">
            <li><a href="homepage.html"><i class="fa-solid fa-house"></i><span>Home</span></a></li>
            
            <li>
                <a href="quizzes.html">
                <img src="https://img.icons8.com/?size=100&id=rx6rZTa05YPn&format=png&color=FFFFFF" 
                    alt="Quiz Icon" class="menu-icon" />
                <span>Quizzes</span>
                </a>
            </li>
            
            <li><a href="leaderboards.html"><i class="fa-solid fa-trophy"></i><span>Leaderboards</span></a></li>
            
            <li class="active"><a href="community.html"><i class="fa-solid fa-comments"></i><span>Community</span></a></li>
            
            <li><a href="profile.html"><i class="fa-solid fa-user"></i><span>Profile</span></a></li>
        </ul>
        <div class="logout" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>Logout</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
    <header>
        <div class="tabs">
            <button class="tab active" data-tab="discussions">Discussions</button>
            <button class="tab" data-tab="my-feed">My Feed</button>
        </div>
      <div class="profile-card">
        <img
          src="https://img.icons8.com/color/96/000000/user-male-circle--v1.png"
          alt="Profile"
        />
        <div class="profile-info">
          <h3>User Name</h3>
          <p>BSIT Student</p>
        </div>
      </div>
    </header>

    <section id="discussions-section" class="section">
      <div class="discussion-main">
        <div class="new-post"> ... </div>
        <!-- JS dynamically injects all posts here -->
      </div>

      <aside id="trending-topics">
        <h3>ðŸ”¥ Trending Topics</h3>
        <ul class="trending-list"></ul>
      </aside>
    </section>



<!-- ===== Feed Section ===== -->
<section id="feed-section" class="section">
  <!-- New Feed Post Box -->
  <div class="feed-new-post">
    <div class="feed-post-header">
      <img
        src="https://img.icons8.com/color/48/000000/user-male-circle--v1.png"
        alt="User"
        class="feed-user-icon"
      />
      <input
        type="text"
        id="feed-new-text"
        placeholder="What's on your mind?"
      />
    </div>

    <div class="feed-post-attachments">
      <label>
        <i class="fa-solid fa-image"></i>
        <input type="file" id="feed-image-upload" accept="image/*" hidden />
      </label>
      <label>
        <i class="fa-solid fa-video"></i>
        <input type="file" id="feed-video-upload" accept="video/*" hidden />
      </label>
      <label>
        <i class="fa-solid fa-link"></i>
        <input type="url" id="feed-link-input" placeholder="Paste link..." />
      </label>
    </div>

    <button id="feed-post-btn">
      <i class="fa-solid fa-paper-plane"></i> Post
    </button>
  </div>

  <!-- Feed Posts Container -->
  <div id="feed-posts-container">
    <!-- Posts are dynamically rendered here by feed.js -->
  </div>
</section>
    

    <footer>Â© 2025 QuizIt â€” All Rights Reserved</footer>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  // ----- CONFIG -----
const API_BASE =
  window.location.hostname.includes("render.com")
    ? "https://quizit-backend.onrender.com"
    : "http://localhost:3000";

const COMMUNITY_ENDPOINT = `${API_BASE}/community`;

// Helper selectors
const qs = (sel) => document.querySelector(sel);
const qsa = (sel) => Array.from(document.querySelectorAll(sel));

  // ----- TAB SWITCHING -----
const tabs = document.querySelectorAll('.tab');
const sections = {
  discussions: document.getElementById('discussions-section'),
  'my-feed': document.getElementById('feed-section')
};

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    // Toggle active class on tabs
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    // Show only the corresponding section
    Object.values(sections).forEach(sec => sec.classList.remove('active'));
    sections[tab.dataset.tab].classList.add('active');
  });
});

// Initialize default section
sections['discussions'].classList.add('active');


  // ----- SESSION CHECK -----
  const sessionUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
  if (!sessionUser) {
    alert("Please log in first.");
    window.location.href = "index.html";
    return;
  }

  // ----- LOAD USERS -----
let users = [];
try {
  const res = await fetch(USERS_ENDPOINT); // GET all users
  if (!res.ok) throw new Error("json-server not available");
  users = await res.json();
} catch (err) {
  console.warn("json-server unavailable, falling back to localStorage...");
  const stored = localStorage.getItem(LOCAL_USERS_KEY);
  users = stored ? JSON.parse(stored) : [];
}

// Find logged-in user
let user = users.find(u => u.email === sessionUser.email);
if (!user) {
  alert("User not found.");
  sessionStorage.clear();
  window.location.href = "index.html";
  return;
}
  // Load discussions and topics
  async function loadCommunity() {
    try {
      const res = await fetch(COMMUNITY_ENDPOINT);
      const data = await res.json();
      renderDiscussions(data.discussions);
      renderTopics(data.topics);
    } catch (err) {
      console.error("Error loading community:", err);
    }
  }
  // Render discussions dynamically
function renderDiscussions(discussions) {
  const main = qs(".discussion-main");
  main.innerHTML = `
    <div class="new-post">
      <div class="new-post-header">
        <img src="https://img.icons8.com/color/48/000000/user-male-circle--v1.png" class="user-icon" />
        <input type="text" id="new-post-title" placeholder="Post title..." />
      </div>
      <input type="text" id="new-post-text" placeholder="Share your thoughts..." />
      <button id="post-btn"><i class="fa-solid fa-paper-plane"></i> Post</button>
    </div>
  `;

  discussions.forEach((d) => {
    const card = document.createElement("div");
    card.classList.add("discussion-card");
    card.setAttribute("data-id", d.id);

    card.innerHTML = `
      <div class="vote-panel">
        <button class="vote-btn upvote">â¬†</button>
        <span class="vote-count">${d.votes}</span>
        <button class="vote-btn downvote">â¬‡</button>
      </div>
      <div class="post-content">
        <h3>${d.title}</h3>
        <p>
          <img src="https://img.icons8.com/color/24/000000/user-female-circle.png" class="user-icon-small" />
          <strong>${getUserName(d.author)}:</strong> ${d.content}
        </p>
        <div class="post-actions">
          <span class="comments-toggle">ðŸ’¬ ${d.comments.length} Comment</span>
          <span>ðŸ•’ ${d.timestamp}</span>
        </div>
        <div class="comments-section hidden">
          ${d.comments
            .map(
              (c) => `
              <div class="comment">
                <img src="${getUserAvatar(c.author)}" class="user-icon-small" />
                <strong>${getUserName(c.author)}:</strong> ${c.content}
              </div>`
            )
            .join("")}
          <div class="reply-input-container">
            <input type="text" class="reply-input" placeholder="Write a reply..." />
            <button class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    `;

    main.appendChild(card);
  });

  // Toggle comments
  qsa(".comments-toggle").forEach((btn) =>
    btn.addEventListener("click", (e) => {
      const section = e.target
        .closest(".post-content")
        .querySelector(".comments-section");
      section.classList.toggle("hidden");
    })
  );

  // Handle upvote/downvote
  qsa(".upvote").forEach((btn) =>
    btn.addEventListener("click", () => updateVote(btn, 1))
  );
  qsa(".downvote").forEach((btn) =>
    btn.addEventListener("click", () => updateVote(btn, -1))
  );
}

// Handle voting updates
function updateVote(btn, change) {
  const card = btn.closest(".discussion-card");
  const countEl = card.querySelector(".vote-count");
  let votes = parseInt(countEl.textContent) + change;
  if (votes < 0) votes = 0;
  countEl.textContent = votes;
}

// Render trending topics
function renderTopics(topics) {
  const list = qs(".trending-list");
  list.innerHTML = topics
    .map(
      (t) => `
      <li>
        <span class="topic-tag">${t.tag}</span>
        <span class="topic-title">${t.title}</span>
        <span class="topic-count">${t.count}</span>
      </li>`
    )
    .join("");
}

// Helpers to match user info
function getUserName(id) {
  if (id === 1) return "Alice";
  if (id === 2) return "You";
  return "Guest";
}

function getUserAvatar(id) {
  if (id === 1)
    return "https://img.icons8.com/color/48/000000/user-female-circle.png";
  if (id === 2)
    return "https://img.icons8.com/color/48/000000/user-male-circle--v1.png";
  return "https://img.icons8.com/color/48/000000/user.png";
}

// Initialize
document.addEventListener("DOMContentLoaded", loadCommunity);

// Load user's feed (their discussions only)
async function loadUserFeed() {
  try {
    const res = await fetch(COMMUNITY_ENDPOINT);
    const data = await res.json();

    // Filter to user's own discussions
    const myPosts = data.discussions.filter(
      (post) => post.author === CURRENT_USER_ID
    );

    renderUserFeed(myPosts);
  } catch (err) {
    console.error("Error loading feed:", err);
  }
}

// Render feed posts
function renderUserFeed(posts) {
  const container = qs("#feed-posts-container");
  container.innerHTML = "";

  if (posts.length === 0) {
    container.innerHTML = `<p class="no-posts">You havenâ€™t posted anything yet.</p>`;
    return;
  }

  posts.forEach((p) => {
    const postCard = document.createElement("div");
    postCard.classList.add("feed-post-card");

    postCard.innerHTML = `
      <div class="feed-post-header">
        <img src="https://img.icons8.com/color/48/000000/user-male-circle--v1.png" alt="User" class="feed-user-icon">
        <div>
          <h4 class="feed-user-name">${getUserName(p.author)}</h4>
          <p class="feed-timestamp">${p.timestamp}</p>
        </div>
      </div>

      <p class="feed-post-content">${p.title}: ${p.content}</p>

      <div class="feed-post-actions">
        <div class="feed-left-actions">
          <button class="feed-like-btn"><i class="fa-solid fa-thumbs-up"></i> Like <span class="feed-like-count">${p.votes}</span></button>
          <button class="feed-comment-btn"><i class="fa-solid fa-comment"></i> Comment (${p.comments.length})</button>
        </div>
        <button class="feed-share-btn"><i class="fa-solid fa-share"></i> Share</button>
      </div>

      <div class="feed-comment-section hidden">
        <div class="feed-comment-input">
          <input type="text" class="feed-comment-text" placeholder="Write a comment..." />
          <button class="feed-comment-send"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
        <div class="feed-comment-list">
          ${p.comments
            .map(
              (c) => `
            <div class="feed-comment">
              <strong>${getUserName(c.author)}:</strong> ${c.content}
            </div>`
            )
            .join("")}
        </div>
      </div>
    `;

    container.appendChild(postCard);
  });

  // Toggle comment sections
  qsa(".feed-comment-btn").forEach((btn) =>
    btn.addEventListener("click", (e) => {
      const section = e.target
        .closest(".feed-post-card")
        .querySelector(".feed-comment-section");
      section.classList.toggle("hidden");
    })
  );
}

function getUserName(id) {
  if (id === 1) return "Alice";
  if (id === 2) return "You";
  return "Guest";
}

// Initialize feed
document.addEventListener("DOMContentLoaded", loadUserFeed);

  // ----- ELEMENTS -----
  const profileNameEl = qs(".profile-info h3");

  // ----- RENDER FUNCTIONS -----
  function renderProfile() {
    profileNameEl.textContent = user.fullname;
    updateXP();
  }

  // ----- INITIALIZE -----
  renderProfile();

  // ----- LOGOUT -----
  window.logout = function() {
    sessionStorage.clear();
    window.location.href = "index.html";
  };

  const sidebar = document.querySelector('.sidebar');
  const toggleBtn = document.getElementById('toggleSidebar');

  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
  });
});



</script>


</body>
</html>
